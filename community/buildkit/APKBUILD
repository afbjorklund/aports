# Contributor: Anders F Björklund <anders.f.bjorklund@gmail.com>
# Maintainer: Anders F Björklund <anders.f.bjorklund@gmail.com>

pkgname=buildkit

# NOTE: buildkit tries to get REVISION from git, but we're building from a tarball.
_commit=8d2625494a6a3d413e3d875a2ff7dd9b1ed1b1a9
pkgver=0.9.3
pkgrel=0
pkgdesc="Container build utility and daemon"
url="https://github.com/moby/buildkit"
arch="all"
license="Apache-2.0"
depends="containerd"
makedepends="go libseccomp-dev"
subpackages="
	$pkgname-openrc
"
source="buildkit-$pkgver.tar.gz::https://github.com/moby/buildkit/archive/v$pkgver.tar.gz
	buildkit.confd
	buildkit.initd
"
builddir="$srcdir/src/github.com/moby/buildkit"

prepare() {
	cd "$srcdir"
	export GOPATH="$PWD"
	mkdir -p "$(dirname "$srcdir/src/github.com/moby/buildkit")"
	ln -s "$PWD/$pkgname-$pkgver" "$builddir"
	cd "$builddir"

	default_prepare
}

build() {
	export GO111MODULE=on

	TAGS="osusergo netgo seccomp"
	VERSIONFLAGS="
	-X github.com/moby/buildkit/version.Version=v$pkgver
	-X github.com/moby/buildkit/version.Revision=$_commit
	"
	GOLDFLAGS="-w -s"

	go build -tags "$TAGS" -ldflags "$VERSIONFLAGS $GOLDFLAGS" ./cmd/buildctl
	go build -tags "$TAGS" -ldflags "$VERSIONFLAGS $GOLDFLAGS" ./cmd/buildkitd
}

check() {
	./buildctl --version
	./buildkitd --version
}

package() {
	install -d "$pkgdir"/usr/bin/
	install -Dsm755 "$builddir"/buildctl "$pkgdir"/usr/bin/
	install -Dsm755 "$builddir"/buildkitd "$pkgdir"/usr/bin/

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm755 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
0e68143996c4ad8a5b1c2882860eef866f4b4c0b4c78d8443aa0cdd7a65192a658db60b84d0df2a06a4f2842f981bcbcbee7562577ace31d7847c62e82c694ea  buildkit-0.9.3.tar.gz
4dbd51349eb085139db557fa2fb100fee6f8371007f508dc4f276f27c72340c6b84f6030d8956d87653e6bef697a03878af387f45e189f23c64ac13dcfe7f5c6  buildkit.confd
3a86bc22b1a584c2ec7fe3b290b0e2288e597e7ec5d1e3888bc5a1364108371f2f888bf96215ce4d296cce2ea0124c1057b70e8bb560d4ef8303a4ff92906ef0  buildkit.initd
"
